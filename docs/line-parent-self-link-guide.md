# 親御さん向け：LINE連携とカード紐づけガイド

## 📋 概要

このガイドでは、親御さんが自分でLINEアカウントとお子様のNFCカードを紐づける方法を説明します。管理者の介入なしで、簡単に設定できます。

---

## 🎯 紐づけの流れ

```
1. LINE公式アカウントに「紐づけ」などのメッセージを送信
   ↓
2. LINE公式アカウントからURLが返信される
   ↓
3. 返信されたURLをタップして開く
   ↓
4. お子様のカードIDをQRコードで読み取る、または手動で入力
   ↓
5. 自動的に紐づけが完了
   ↓
6. 入退室通知が届くようになる
```

---

## 📱 ステップバイステップ手順

### ステップ1: LINE公式アカウントにメッセージを送信

LINE公式アカウントと友だちになっていることを確認し、以下のいずれかのメッセージを送信してください：

- 「紐づけ」
- 「紐付け」
- 「登録」
- 「設定」
- 「カード登録」
- 「通知登録」

**例:**
```
紐づけ
```

### ステップ2: 返信されたURLを確認

LINE公式アカウントから以下のようなメッセージが返信されます：

```
カード紐づけを開始します。

以下のURLにアクセスして、お子様のNFCカードをタッチしてください。

https://your-domain.vercel.app/link-card?token=abc123...

※このURLは1時間有効です。
```

### ステップ3: URLをタップして開く

返信されたメッセージ内のURLをタップして、ブラウザで開きます。

### ステップ4: カードIDを読み取る

以下の2つの方法から選択できます：

#### 方法1: QRコードで読み取る（推奨）

1. スマートフォンでURLを開く
2. 「QRコードを読み取る」ボタンをタップ
3. カメラの権限を許可（初回のみ）
4. **お子様のカードIDが記載されたQRコードをカメラで読み取る**
   - このQRコードは、管理画面から出力できます（後述）
   - または、カードIDを直接QRコードに変換したものを使用
5. 読み取りが完了すると、自動的に紐づけが開始されます

#### 方法2: カードIDを手動で入力

1. スマートフォンでURLを開く
2. 下の「カードIDを手動で入力」欄にカードIDを入力
   - カードIDは管理画面で確認できます
   - 管理者に問い合わせて取得してください
   - 例: `04:e9:41:50:6f:61:80`
3. 「入力したIDで登録」ボタンをタップ
4. 紐づけが完了すると、完了メッセージが表示されます

### ステップ5: 完了確認

紐づけが完了すると、以下のようなメッセージが表示されます：

```
✅ 紐付け完了

太郎さんとの紐付けが完了しました。
これから入退室通知が届くようになります。
```

---

## 🖨️ QRコードの取得方法

### 方法1: 管理画面から出力（推奨）

1. 管理者に連絡して、お子様のカードIDのQRコードを出力してもらう
2. 管理者は管理画面（`/admin/students/[生徒ID]`）からQRコードを生成・ダウンロードできます
3. 出力されたQRコードを印刷または画像として受け取る

### 方法2: カードIDを直接QRコードに変換

カードIDが分かっている場合、以下のようなオンラインQRコード生成ツールを使用できます：

- https://www.qr-code-generator.com/
- https://www.the-qrcode-generator.com/

**手順:**
1. 上記サイトにアクセス
2. カードID（例: `04:e9:41:50:6f:61:80`）を入力
3. QRコードを生成
4. ダウンロードまたは印刷

---

## ⚠️ 注意事項

### QRコード読み取りについて

- **対応ブラウザ:** Chrome、Edge、Safari（最新版）
- **カメラ権限:** 初回のみカメラの使用許可が必要です
- **QRコード形式:** カードIDが記載されたQRコードを読み取ります
  - URL形式: `https://example.com?cardId=04:e9:41:50:6f:61:80`
  - テキスト形式: `04:e9:41:50:6f:61:80`（直接カードID）

### 手動入力について

- QRコードが読み取れない場合、カードIDを手動で入力できます
- カードIDは管理画面で確認できます
- 形式: `04:e9:41:50:6f:61:80`（コロン区切り、小文字推奨）

### セキュリティ

- トークンは1時間で自動的に無効化されます
- トークンは1回のみ使用可能です
- トークンは32バイトのランダム文字列で、推測困難です

---

## 🐛 トラブルシューティング

### 1. URLが発行されない

**チェック項目:**
- LINE公式アカウントと友だちになっているか
- 正しいメッセージ（「紐づけ」「登録」など）を送信しているか
- 管理者に問い合わせて、システムが正常に動作しているか確認

### 2. QRコードが読み取れない

**チェック項目:**
- スマートフォンでアクセスしているか（PCでもカメラがあれば可能）
- カメラの権限が許可されているか
- ブラウザがBarcodeDetector APIに対応しているか（Chrome、Edge、Safari最新版）
- QRコードが鮮明で、カメラに正しく映っているか
- 暗すぎる、または明るすぎる環境でないか

**解決方法:**
- QRコードが読み取れない場合は、手動入力をご利用ください
- カードIDは管理者に問い合わせて取得してください

### 3. 紐付けが完了しない

**チェック項目:**
- トークンの有効期限内か（1時間以内）
- トークンが既に使用済みでないか
- カードが正しく登録されているか
- 生徒が在籍中か

**解決方法:**
- 新しいトークンを発行してもらう（LINE公式アカウントに再度「紐づけ」と送信）
- 管理者に問い合わせて、カードの登録状態を確認

### 4. 通知が届かない

**チェック項目:**
- 紐付けが正しく完了しているか
- LINEアカウントがアクティブか
- お子様が実際に入退室しているか

**解決方法:**
- 管理者に問い合わせて、紐付け状態を確認
- LINEアカウントの通知設定を確認

---

## 📞 サポート

問題が解決しない場合は、管理者までお問い合わせください。

---

## 更新履歴

- 2026-01-26: 初版作成

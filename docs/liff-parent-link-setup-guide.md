# LIFF親子紐付け機能 セットアップガイド

## 📋 目次
1. [概要](#概要)
2. [LINE Developers 設定](#line-developers-設定)
3. [環境変数の設定](#環境変数の設定)
4. [動作確認](#動作確認)
5. [QRコードの使用方法](#qrコードの使用方法)
6. [NFCカードを使った親御さん登録](#nfcカードを使った親御さん登録) ⭐新機能
7. [NFCカードへの書き込み（オプション）](#nfcカードへの書き込みオプション)
8. [トラブルシューティング](#トラブルシューティング)

---

## 概要

この機能により、親御さん自身のスマートフォンでお子様のNFCカードをタップ、またはQRコードをスキャンすることで、自動的にLINE通知連携が完了します。

### 主な機能
- **デバイス選択**: LINE内でAndroid/iPhoneを選択
- **Android方式**: NFCカードをタップするだけで自動連携
- **iPhone方式**: NFCカードを読み取ってQRコードを生成、スキャンして連携
- **LIFF連携**: LINE内でシームレスに認証・紐付け
- **自動連携**: 手動でのLINE User ID入力が不要

---

## LINE Developers 設定

> **重要**: 2019年11月以降、Messaging APIチャネルにはLIFFアプリを追加できません。**LINEログインチャネル**を使用する必要があります。

### チャネル構成図

```
┌─────────────────────────────────────────────────┐
│         同じプロバイダー内                        │
│                                                 │
│  ┌──────────────────────────────────────┐      │
│  │  LINEログインチャネル                 │      │
│  │  - LIFF対応                          │      │
│  │  - 親子紐付け画面（/parent-link）    │      │
│  │  - ユーザー認証                      │      │
│  └──────────────┬───────────────────────┘      │
│                 │ ボットリンク                  │
│                 ▼                               │
│  ┌──────────────────────────────────────┐      │
│  │  Messaging APIチャネル               │      │
│  │  - 入退室通知の送信                  │      │
│  │  - Webhook受信                       │      │
│  │  - LINE公式アカウント                │      │
│  └──────────────────────────────────────┘      │
│                                                 │
└─────────────────────────────────────────────────┘
```

**役割分担:**
- **LINEログインチャネル** → LIFF（認証・親子紐付け）
- **Messaging APIチャネル** → 通知送信（入退室通知）

### 1. LINE Developersコンソールにログイン

1. [LINE Developers](https://developers.line.biz/ja/) にアクセス
2. プロバイダーを選択（既存のプロバイダーまたは新規作成）

### 2. LINEログインチャネルを作成

> すでにLINEログインチャネルがある場合は、このステップをスキップして「3. LIFFアプリを作成」に進んでください。

1. プロバイダー画面で「チャネルを作成」をクリック
2. 「LINEログイン」を選択
3. 以下の情報を入力：

   | 項目 | 入力内容 |
   |------|---------|
   | **チャネル名** | `親子紐付けLIFF` または任意の名前 |
   | **チャネル説明** | `親御さんとLINE通知を自動連携するためのチャネル` |
   | **アプリタイプ** | `ウェブアプリ` |

4. 利用規約に同意して「作成」をクリック

### 3. LIFFアプリを作成

1. 作成したLINEログインチャネルを開く
2. 「LIFF」タブを選択
3. 「追加」ボタンをクリック
4. 以下の設定を入力：

   | 項目 | 設定値 |
   |------|--------|
   | **LIFFアプリ名** | `親子紐付け` または任意の名前 |
   | **サイズ** | `Full` |
   | **エンドポイントURL** | `https://yourdomain.com/parent-link` |
   | **Scope** | `profile` にチェック |
   | **ボットリンク機能** | `On (Aggressive)` を選択 |
   | **モジュールモード** | `Off` |

   > **重要**: `エンドポイントURL` は実際のドメインに置き換えてください
   > 
   > **例**:
   > - Vercelの場合: `https://your-app.vercel.app/parent-link`
   > - 独自ドメインの場合: `https://your-domain.com/parent-link`

5. 「作成」をクリック

### 4. ボットリンク機能の設定

LIFFから直接LINE公式アカウントに友だち追加できるようにします。

1. LIFFアプリの編集画面で「ボットリンク機能」を確認
2. 「ボットリンク機能」が `On (Aggressive)` になっていることを確認
3. 「連携するMessaging APIチャネル」で、既存のMessaging APIチャネルを選択
   - これにより、LIFF経由でLINE公式アカウントに友だち追加されます
   - 友だち追加することで、入退室通知が受信できるようになります

> **注意**: ボットリンク機能を有効にするには、同じプロバイダー内にMessaging APIチャネルが必要です。

### 5. LIFF IDを取得

1. 作成したLIFFアプリの詳細画面を開く
2. **LIFF ID** をコピー（例: `1234567890-abcdefgh`）
3. この値を次のステップで環境変数に設定します

---

## 環境変数の設定

### 1. `.env.local` ファイルに追加

プロジェクトルートの `.env.local` ファイルに以下を追加：

```bash
# LIFF設定
NEXT_PUBLIC_LIFF_ID=1234567890-abcdefgh
```

> **注意**: `1234567890-abcdefgh` の部分を、前の手順で取得した実際のLIFF IDに置き換えてください。

### 2. 環境変数の確認

既存の環境変数も確認してください：

```bash
# LINE Messaging API
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Site ID
SITE_ID=your_site_id
```

### 3. アプリを再起動

```bash
npm run dev
```

---

## 動作確認

### 1. QRコード生成

1. 管理画面にログイン
2. 「親御さん管理」ページを開く
3. 親御さんの行の「QRコードアイコン」をクリック
4. 生徒ごとのQRコードが表示されることを確認

### 2. テスト環境での確認

1. 生成されたQRコードをスマホでスキャン
2. LINEアプリが開き、LIFF画面が表示されることを確認
3. 生徒情報と親御さん情報が正しく表示されることを確認
4. 「LINE通知を開始する」ボタンをクリック
5. 連携完了メッセージが表示されることを確認

### 3. データベース確認

Supabase Studioで `parent_line_accounts` テーブルを確認：

```sql
SELECT 
  pla.id,
  pla.line_user_id,
  pla.is_active,
  p.name as parent_name
FROM parent_line_accounts pla
JOIN parents p ON p.id = pla.parent_id
WHERE pla.is_active = true;
```

---

## QRコードの使用方法

### 1. QRコード生成（管理画面）

1. 「親御さん管理」ページを開く
2. 親御さんの行の「QRコードアイコン」をクリック
3. QRコードダイアログが表示される

### 2. QRコード送信

以下の方法で親御さんに送信できます：

#### 方法1: 画像として保存して送信
1. 「保存」ボタンをクリック
2. PNG画像がダウンロードされる
3. LINEやメールで親御さんに送信

#### 方法2: URLをコピーして送信
1. 「URL」ボタンをクリック
2. クリップボードにURLがコピーされる
3. LINEやメールにペーストして送信

#### 方法3: 共有機能を使用（スマホのみ）
1. 「共有」ボタンをクリック
2. 端末の共有メニューが表示される
3. LINEやメールアプリを選択して送信

### 3. 親御さんの操作

1. 受け取ったQRコードをスマホでスキャン、またはURLをタップ
2. LINEアプリが自動的に開く
3. 生徒情報と親御さん情報を確認
4. 「LINE通知を開始する」ボタンをタップ
5. 連携完了！

---

## LINE内でのNFCカード登録 ⭐新機能

### 概要

LINE内（LIFF）からデバイスを選択し、お子様のNFCカードを読み取って自動的にLINE連携が完了する機能です。

**URL**: `/parent-link`（デバイス選択） → `/parent-link/android` または `/parent-link/iphone`

### 使い方

#### 1. LINE公式アカウントからアクセス

LINE公式アカウントのメニューから「LINE通知連携」を選択、またはQRコードをスキャンして `/parent-link` にアクセス

#### 2. デバイスを選択

LINE内で「Android」または「iPhone」を選択

#### 3. NFCカードを読み取る

**Androidの場合:**
1. 「NFCカードを読み取る」ボタンをクリック
2. お子様のNFCカードをスマートフォンにタップ
3. カードIDから自動的に生徒情報を取得
4. 自動的にLINE連携が完了

**iPhoneの場合:**
1. 「NFCカードを読み取る」ボタンをクリック（またはカードIDを手動入力）
2. カードIDから自動的に生徒情報を取得
3. QRコードが表示される
4. LINEアプリでQRコードをスキャン
5. 連携が完了

### 特徴

- ✅ **簡単**: カードをタップするだけ
- ✅ **自動化**: 手動入力が不要
- ✅ **全デバイス対応**: Android（NFC直接）、iOS（QRコード）
- ✅ **安全**: カードIDから生徒情報を検証

### 技術的な仕組み

```
1. 親御さんが /parent-register を開く
   ↓
2. 「NFCカードを読み取る」ボタンをクリック
   ↓
3. Web NFC APIでカードのシリアル番号を読み取り
   ↓
4. /api/cards/verify で生徒情報を取得
   ↓
5. /api/parent-link/verify で親御さん情報を取得
   ↓
6. 【Android】自動的に /parent-link に遷移
   【iOS】QRコードを生成して表示
   ↓
7. LIFFでLINE連携完了
```

### 注意事項

- **NFC対応デバイスが必要**: Android ChromeでNFC読み取りが可能
- **iOSの制限**: iOSはWeb NFC APIに対応していないため、QRコード方式に自動切り替え
- **カード登録済み**: お子様のNFCカードが事前に登録されている必要があります

---

## NFCカードへの書き込み（オプション）

> **注意**: この機能は現在の入退室システムと併用する場合、NFCカードに複数のURLを書き込む必要があります。推奨は **QRコード方式** です。

### 1. LIFF URLの形式

```
https://liff.line.me/1234567890-abcdefgh?liff.state=%2Fparent-link%3FstudentId%3D{studentId}
```

例:
```
https://liff.line.me/1234567890-abcdefgh?liff.state=%2Fparent-link%3FstudentId%3D12345
```

### 2. NFCカードへの書き込み

NFCカード書き込みアプリ（NFC Tools等）を使用：

1. アプリで「書き込み」を選択
2. 「URL/URI」レコードを追加
3. 上記のLIFF URLを入力
4. NFCカードにタッチして書き込み

### 3. 注意事項

- **1枚のNFCカードには1つのURLのみ**: 入退室用とLIFF用を同時に書き込めない
- **推奨**: 入退室用はNFCカード、親子紐付けはQRコードで運用

---

## トラブルシューティング

### 問題1: 「Messaging APIチャネルにはLIFFアプリを追加できません」エラー

**症状**: LINE DevelopersでLIFFアプリを作成しようとすると、「LINEログインチャネルを使用してください」というメッセージが表示される

**解決策**:
1. Messaging APIチャネルではなく、**LINEログインチャネル**を作成してください
2. LINEログインチャネルの作成方法は、このガイドの「LINE Developers 設定」セクションを参照
3. 2019年11月以降、Messaging APIチャネルにはLIFFアプリを追加できなくなりました

### 問題2: LIFFが初期化されない

**症状**: 「LINEの初期化に失敗しました」エラー

**解決策**:
1. `.env.local` の `NEXT_PUBLIC_LIFF_ID` が正しいか確認
2. LIFF IDの形式（ハイフン含む）が正しいか確認
3. LINEログインチャネルで作成したLIFF IDを使用しているか確認
4. アプリを再起動（`npm run dev` または `npm run build && npm start`）
5. ブラウザのキャッシュをクリア

### 問題3: ボットリンク機能が動作しない

**症状**: LIFF経由でLINE公式アカウントに友だち追加されない

**解決策**:
1. LIFFアプリの「ボットリンク機能」が `On (Aggressive)` になっているか確認
2. 「連携するMessaging APIチャネル」が正しく設定されているか確認
3. Messaging APIチャネルとLINEログインチャネルが同じプロバイダー内にあるか確認

### 問題4: 親御さん情報が取得できない

**症状**: 「親御さんが登録されていません」エラー

**解決策**:
1. 管理画面で親御さんと生徒が正しく紐付けられているか確認
2. 生徒の `role` が `'student'` になっているか確認（`'part_time'` や `'full_time'` は対象外）
3. 生徒の `status` が `'active'` になっているか確認

```sql
-- 確認用クエリ
SELECT 
  s.id,
  s.name as student_name,
  s.role,
  s.status,
  p.name as parent_name
FROM students s
LEFT JOIN parent_students ps ON ps.student_id = s.id
LEFT JOIN parents p ON p.id = ps.parent_id
WHERE s.id = 'your_student_id';
```

### 問題5: LINE連携が完了しない

**症状**: 「LINE連携に失敗しました」エラー

**解決策**:
1. ネットワーク接続を確認
2. Supabaseの接続状態を確認
3. ブラウザのコンソールログを確認（F12 → Console）
4. Vercelのログを確認（本番環境の場合）

### 問題6: QRコードが生成されない

**症状**: QRコードが空白またはエラー

**解決策**:
1. `qrcode` ライブラリがインストールされているか確認
   ```bash
   npm install qrcode @types/qrcode
   ```
2. 親御さんに生徒が紐付けられているか確認
3. ブラウザのコンソールログを確認

### 問題7: URLが間違っている

**症状**: QRコードをスキャンすると404エラー

**解決策**:
1. LIFF設定のエンドポイントURLが正しいか確認
2. 本番環境のドメインが正しく設定されているか確認
3. `/parent-link` ページが正しくデプロイされているか確認

---

## よくある質問（FAQ）

### Q1: 既にLINE連携済みの親御さんが再度QRコードをスキャンするとどうなりますか？

**A**: 「既にLINE連携済みです」というメッセージが表示され、既存の連携が維持されます。重複登録されることはありません。

### Q2: 1人の親御さんが複数の生徒に紐づいている場合、どうなりますか？

**A**: 各生徒ごとに専用のQRコードが生成されます。親御さんは最初にスキャンしたQRコードで連携すれば、全ての紐づけられた生徒の通知を受け取ることができます。

### Q3: QRコードに有効期限はありますか？

**A**: いいえ、QRコードに有効期限はありません。生成後、いつでも使用できます。

### Q4: LINEアカウントを持っていない親御さんはどうすればよいですか？

**A**: LINEアプリをインストールして、LINE公式アカウントを友だち追加する必要があります。ボットリンク機能により、LIFF経由で自動的に友だち追加されます。

### Q5-2: LINEログインチャネルとMessaging APIチャネルの違いは何ですか？

**A**: 
- **LINEログインチャネル**: ユーザー認証とLIFFアプリの実行に使用
- **Messaging APIチャネル**: メッセージ送信とWebhook受信に使用

親子紐付け機能では、両方のチャネルが必要です：
- LINEログインチャネル → LIFF（認証・紐付け画面）
- Messaging APIチャネル → 入退室通知の送信

### Q6: 管理画面での手動紐付けは必要なくなりますか？

**A**: いいえ、管理画面での手動紐付け機能は残されています。QRコードが使えない場合や、トラブル時の対応として使用できます。

---

## セキュリティに関する注意事項

1. **QRコードの取り扱い**
   - QRコードは親御さん本人にのみ送信してください
   - 第三者に共有しないよう親御さんに注意喚起してください

2. **LINE User IDの保護**
   - LINE User IDは個人情報として適切に管理してください
   - 不要になったアカウントは `is_active = false` にして無効化してください

3. **LIFF IDの保護**
   - LIFF IDは公開されても問題ありませんが、不要に共有しないでください
   - LINE Channel Access Tokenは絶対に公開しないでください

---

## 関連ドキュメント

- [LINE通知機能の仕組み](./line-notification-mechanism-explanation.md)
- [LINE Messaging API公式ドキュメント](https://developers.line.biz/ja/docs/messaging-api/)
- [LIFF公式ドキュメント](https://developers.line.biz/ja/docs/liff/)

---

## サポート

問題が解決しない場合は、以下の情報を添えてお問い合わせください：

- エラーメッセージの全文
- ブラウザのコンソールログ
- 発生した手順
- 使用しているブラウザとOSのバージョン

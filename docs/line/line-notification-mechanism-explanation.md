# LINEé€šçŸ¥æ©Ÿèƒ½ã®ä»•çµ„ã¿ - èª¬æ˜ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ğŸ“‹ ç›®æ¬¡
1. [ä¸€èˆ¬å‘ã‘èª¬æ˜ï¼ˆéæŠ€è¡“è€…å‘ã‘ï¼‰](#ä¸€èˆ¬å‘ã‘èª¬æ˜éæŠ€è¡“è€…å‘ã‘)
2. [æŠ€è¡“è€…å‘ã‘èª¬æ˜](#æŠ€è¡“è€…å‘ã‘èª¬æ˜)
3. [ã‚ˆãã‚ã‚‹è³ªå•](#ã‚ˆãã‚ã‚‹è³ªå•)

---

## ä¸€èˆ¬å‘ã‘èª¬æ˜ï¼ˆéæŠ€è¡“è€…å‘ã‘ï¼‰

### ã€Œã©ã†ã„ã†ä»•çµ„ã¿ãªã®ï¼Ÿã€ã¨èã‹ã‚ŒãŸã‚‰

**ç°¡æ½”ç‰ˆï¼ˆ30ç§’ã§èª¬æ˜ï¼‰:**
> ã€Œç”Ÿå¾’ãŒNFCã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ãã®ç”Ÿå¾’ã®è¦ªå¾¡ã•ã‚“ã®LINEã«é€šçŸ¥ãŒå±Šãã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚äº‹å‰ã«è¦ªå¾¡ã•ã‚“ã¨ç”Ÿå¾’ã‚’ç´ã¥ã‘ã¦ã€LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨é€£æºã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã€

**è©³ç´°ç‰ˆï¼ˆ2-3åˆ†ã§èª¬æ˜ï¼‰:**

#### 1. äº‹å‰æº–å‚™ï¼ˆåˆå›ã®ã¿ï¼‰
```
â‘  è¦ªå¾¡ã•ã‚“ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«ç™»éŒ²
â‘¡ è¦ªå¾¡ã•ã‚“ã¨ç”Ÿå¾’ã‚’ç´ã¥ã‘
â‘¢ è¦ªå¾¡ã•ã‚“ãŒLINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ 
â‘£ ã‚·ã‚¹ãƒ†ãƒ ãŒè¦ªå¾¡ã•ã‚“ã®LINE IDã‚’è¨˜éŒ²
```

#### 2. æ—¥å¸¸çš„ãªå‹•ä½œï¼ˆè‡ªå‹•ï¼‰
```
ç”Ÿå¾’ãŒNFCã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ
    â†“
ã‚·ã‚¹ãƒ†ãƒ ãŒã€Œèª°ãŒå…¥å®¤/é€€å®¤ã—ãŸã‹ã€ã‚’è¨˜éŒ²
    â†“
ãã®ç”Ÿå¾’ã®è¦ªå¾¡ã•ã‚“ã‚’æ¤œç´¢
    â†“
è¦ªå¾¡ã•ã‚“ã®LINE IDã‚’å–å¾—
    â†“
LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰é€šçŸ¥ã‚’é€ä¿¡
    â†“
è¦ªå¾¡ã•ã‚“ã®LINEã‚¢ãƒ—ãƒªã«é€šçŸ¥ãŒå±Šã
```

#### 3. é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã€Œ[ç”Ÿå¾’å]ã•ã‚“ãŒå…¥å®¤ã—ã¾ã—ãŸã€‚\næ™‚åˆ»: [ç¾åœ¨æ™‚åˆ»]ã€
- ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½: ç®¡ç†ç”»é¢ã®ã€Œè¨­å®šã€â†’ã€Œé€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ã§å¤‰æ›´å¯èƒ½

---

## æŠ€è¡“è€…å‘ã‘èª¬æ˜

### ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NFCã‚«ãƒ¼ãƒ‰ã‚¿ãƒƒãƒ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/access-logs (POST) â”‚
â”‚  å…¥é€€å®¤ãƒ­ã‚°ä½œæˆAPI        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”Ÿå¾’æƒ…å ±å–å¾—            â”‚
â”‚  students ãƒ†ãƒ¼ãƒ–ãƒ«       â”‚
â”‚  role='student' ç¢ºèª     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¦ªå¾¡ã•ã‚“æ¤œç´¢            â”‚
â”‚  parent_students ãƒ†ãƒ¼ãƒ–ãƒ«â”‚
â”‚  (student_id ã§æ¤œç´¢)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—      â”‚
â”‚  parent_line_accounts   â”‚
â”‚  (parent_id, is_active)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—     â”‚
â”‚  point_settings ãƒ†ãƒ¼ãƒ–ãƒ« â”‚
â”‚  (entry/exit_template)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LINE Messaging API      â”‚
â”‚  POST /v2/bot/message/   â”‚
â”‚  push                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€ä¿¡å±¥æ­´è¨˜éŒ²            â”‚
â”‚  line_notification_logs â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

```sql
-- ç”Ÿå¾’ãƒ†ãƒ¼ãƒ–ãƒ«
students
  - id (UUID)
  - name
  - role ('student' | 'part_time' | 'full_time')
  - site_id

-- è¦ªå¾¡ã•ã‚“ãƒ†ãƒ¼ãƒ–ãƒ«
parents
  - id (UUID)
  - name
  - phone_number
  - email

-- è¦ªå­ç´ã¥ã‘ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¤šå¯¾å¤šï¼‰
parent_students
  - id (UUID)
  - parent_id (FK â†’ parents.id)
  - student_id (FK â†’ students.id)
  - is_primary (boolean)

-- LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
parent_line_accounts
  - id (UUID)
  - parent_id (FK â†’ parents.id)
  - line_user_id (text) -- LINE User ID
  - line_display_name (text)
  - is_active (boolean) -- true ã®å ´åˆã®ã¿é€šçŸ¥é€ä¿¡
  - subscribed_at (timestamp)
  - unsubscribed_at (timestamp)

-- é€šçŸ¥é€ä¿¡å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
line_notification_logs
  - id (UUID)
  - site_id
  - access_log_id (FK â†’ access_logs.id)
  - parent_id (FK â†’ parents.id)
  - student_id (FK â†’ students.id)
  - event_type ('entry' | 'exit' | 'forced_exit')
  - line_user_id (text)
  - message_sent (text)
  - status ('success' | 'failed')
  - error_message (text)
  - created_at (timestamp)
```

### ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼

#### 1. å…¥é€€å®¤ãƒ­ã‚°ä½œæˆï¼ˆ`app/api/access-logs/route.ts`ï¼‰

```typescript
// POST /api/access-logs
export async function POST(req: Request) {
  // 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const { studentId, eventType } = await req.json();
  
  // 2. ç”Ÿå¾’æƒ…å ±ã‚’å–å¾—
  const student = await supabase
    .from("students")
    .select("*")
    .eq("id", studentId)
    .single();
  
  // 3. å…¥é€€å®¤ãƒ­ã‚°ã‚’ä½œæˆ
  const log = await supabase
    .from("access_logs")
    .insert({ student_id: studentId, event_type: eventType });
  
  // 4. ç”Ÿå¾’ï¼ˆrole='student'ï¼‰ã®å ´åˆã®ã¿é€šçŸ¥å‡¦ç†
  if (student.role === "student" && 
      (eventType === "entry" || eventType === "exit" || eventType === "forced_exit")) {
    await sendLineNotificationToParents(
      siteId,
      studentId,
      eventType,
      log.id,
      student.name
    );
  }
}
```

#### 2. LINEé€šçŸ¥é€ä¿¡ï¼ˆ`lib/line-notification-utils.ts`ï¼‰

```typescript
export async function sendLineNotificationToParents(
  siteId: string,
  studentId: string,
  eventType: "entry" | "exit" | "forced_exit",
  accessLogId: string,
  studentName: string
) {
  // 1. Supabase Admin Clientï¼ˆRLSãƒã‚¤ãƒ‘ã‚¹ï¼‰
  const supabase = getSupabaseAdmin();
  
  // 2. è¦ªå¾¡ã•ã‚“ã‚’æ¤œç´¢
  const { data: parentStudents } = await supabase
    .from("parent_students")
    .select("parent_id, parents!inner(id, name)")
    .eq("student_id", studentId);
  
  // 3. LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
  const parentIds = parentStudents.map(ps => ps.parents.id);
  const { data: lineAccounts } = await supabase
    .from("parent_line_accounts")
    .select("line_user_id, is_active")
    .in("parent_id", parentIds)
    .eq("is_active", true);
  
  // 4. é€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
  const { data: settings } = await supabase
    .from("point_settings")
    .select("entry_notification_template, exit_notification_template")
    .eq("site_id", siteId)
    .single();
  
  // 5. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
  const template = eventType === "entry" 
    ? settings.entry_notification_template 
    : settings.exit_notification_template;
  const message = template
    .replace(/\[ç”Ÿå¾’å\]/g, studentName)
    .replace(/\[ç¾åœ¨æ™‚åˆ»\]/g, new Date().toLocaleString("ja-JP"));
  
  // 6. LINE Messaging APIã§é€ä¿¡
  for (const lineAccount of lineAccounts) {
    await sendLineMessage(
      process.env.LINE_CHANNEL_ACCESS_TOKEN!,
      lineAccount.line_user_id,
      message
    );
  }
  
  // 7. é€ä¿¡å±¥æ­´ã‚’è¨˜éŒ²
  await supabase.from("line_notification_logs").insert({
    access_log_id: accessLogId,
    parent_id: parentId,
    student_id: studentId,
    event_type: eventType,
    line_user_id: lineAccount.line_user_id,
    message_sent: message,
    status: "success"
  });
}
```

### é‡è¦ãªæŠ€è¡“ãƒã‚¤ãƒ³ãƒˆ

#### 1. RLSï¼ˆRow Level Securityï¼‰ã®ãƒã‚¤ãƒ‘ã‚¹
- **å•é¡Œ**: åŒ¿åã‚­ãƒ¼ï¼ˆ`ANON_KEY`ï¼‰ã§ã¯ã€RLSãƒãƒªã‚·ãƒ¼ã«ã‚ˆã£ã¦`parent_students`ã‚„`parent_line_accounts`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã‚‹
- **è§£æ±º**: `getSupabaseAdmin()`ã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ï¼ˆ`SERVICE_ROLE_KEY`ï¼‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã€RLSã‚’ãƒã‚¤ãƒ‘ã‚¹

```typescript
// âŒ é–“é•ã„ï¼ˆRLSã§åˆ¶é™ã•ã‚Œã‚‹ï¼‰
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

// âœ… æ­£ã—ã„ï¼ˆRLSã‚’ãƒã‚¤ãƒ‘ã‚¹ï¼‰
const supabase = getSupabaseAdmin();
```

#### 2. é€šçŸ¥é€ä¿¡æ¡ä»¶
- `role = 'student'` ã®å ´åˆã®ã¿é€ä¿¡ï¼ˆ`part_time`ã€`full_time`ã¯å¯¾è±¡å¤–ï¼‰
- `eventType` ãŒ `'entry'`ã€`'exit'`ã€`'forced_exit'` ã®å ´åˆã®ã¿é€ä¿¡
- `parent_line_accounts.is_active = true` ã®å ´åˆã®ã¿é€ä¿¡

#### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- LINEé€šçŸ¥ã®ã‚¨ãƒ©ãƒ¼ã¯å…¥é€€å®¤ãƒ­ã‚°ä½œæˆã‚’å¦¨ã’ãªã„ï¼ˆéåŒæœŸå‡¦ç†ï¼‰
- ã‚¨ãƒ©ãƒ¼ã¯`line_notification_logs`ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ã•ã‚Œã‚‹
- ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã«ã‚‚è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒè¨˜éŒ²ã•ã‚Œã‚‹

---

## ã‚ˆãã‚ã‚‹è³ªå•

### Q1: ãªãœé€šçŸ¥ãŒå±Šã‹ãªã„ã®ï¼Ÿ

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**
1. âœ… è¦ªå¾¡ã•ã‚“ã¨ç”Ÿå¾’ãŒç´ã¥ã„ã¦ã„ã‚‹ã‹ï¼ˆ`parent_students`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
2. âœ… LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒé€£æºã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆ`parent_line_accounts`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
3. âœ… `is_active = true` ã«ãªã£ã¦ã„ã‚‹ã‹
4. âœ… ç”Ÿå¾’ã®`role`ãŒ`'student'`ã«ãªã£ã¦ã„ã‚‹ã‹
5. âœ… `LINE_CHANNEL_ACCESS_TOKEN`ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

### Q2: é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„

**æ–¹æ³•:**
1. ç®¡ç†ç”»é¢ â†’ ã€Œè¨­å®šã€â†’ ã€Œé€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€
2. ã€Œå…¥å®¤é€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ã€Œé€€å®¤é€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ã‚’ç·¨é›†
3. `[ç”Ÿå¾’å]`ã€`[ç¾åœ¨æ™‚åˆ»]`ã®ã‚¿ã‚°ãŒä½¿ç”¨å¯èƒ½

### Q3: è¤‡æ•°ã®è¦ªå¾¡ã•ã‚“ã«é€šçŸ¥ã‚’é€ã‚ŠãŸã„

**æ–¹æ³•:**
- `parent_students`ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¤‡æ•°ã®è¦ªå¾¡ã•ã‚“ã‚’ç´ã¥ã‘ã‚‹
- å„è¦ªå¾¡ã•ã‚“ãŒLINEé€£æºã—ã¦ã„ã‚Œã°ã€å…¨å“¡ã«é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã‚‹

### Q4: é€šçŸ¥ã‚’ä¸€æ™‚çš„ã«åœæ­¢ã—ãŸã„

**æ–¹æ³•:**
- `parent_line_accounts`ãƒ†ãƒ¼ãƒ–ãƒ«ã§è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰ã®`is_active`ã‚’`false`ã«å¤‰æ›´
- ã¾ãŸã¯ã€LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰å‹ã ã¡è§£é™¤ï¼ˆ`unsubscribed_at`ãŒè‡ªå‹•è¨˜éŒ²ã•ã‚Œã‚‹ï¼‰

### Q5: é€ä¿¡å±¥æ­´ã‚’ç¢ºèªã—ãŸã„

**æ–¹æ³•:**
- `line_notification_logs`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª
- `status`ãŒ`'success'`ãªã‚‰é€ä¿¡æˆåŠŸã€`'failed'`ãªã‚‰å¤±æ•—
- `error_message`ã«ã‚¨ãƒ©ãƒ¼è©³ç´°ãŒè¨˜éŒ²ã•ã‚Œã‚‹

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æºãƒ•ãƒ­ãƒ¼å®Œå…¨ã‚¬ã‚¤ãƒ‰](./line-integration-flow.md)
- [LINEé€šçŸ¥æ©Ÿèƒ½ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰](./line-notification-setup-guide.md)
- [Webhookï¼ˆã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯ï¼‰ã¨ã¯ï¼Ÿ](./webhook-explanation.md)




# LINE紐づけ用QRコード生成ガイド

## 📋 概要

生徒登録時に紐づけ用QRコードを生成・印刷して、NFCカードと一緒に親御さんにお渡しする機能です。

---

## 🎯 使用フロー

```
1. 管理者が生徒を登録
   ↓
2. 生徒詳細ページで「紐づけ用QRコードを生成」ボタンをクリック
   ↓
3. QRコードをダウンロードして印刷
   ↓
4. NFCカードと一緒に親御さんにお渡し
   ↓
5. 親御さんがQRコードを読み取る
   ↓
6. LINE公式アカウントに遷移
   ↓
7. 「カード紐づけを開始します」とメッセージを送信、またはリッチメニューの「カード紐づけ」ボタンをタップ
   ↓
8. 返信されたURLをタップして、カードを読み取る
   ↓
9. 紐づけ完了
```

---

## 🔧 設定手順

### ステップ1: LINE公式アカウントのURLを取得

1. **LINE Developers Consoleにアクセス**
   - https://developers.line.biz/console/
   - プロバイダー → Messaging APIチャネルを選択

2. **チャネル基本設定を確認**
   - 「チャネル基本設定」タブを開く
   - 「公式アカウント」欄にURLが表示されている場合、それをコピー
   - または、LINE公式アカウントマネージャー (https://manager.line.biz/) で確認

3. **URLの形式**
   - 通常は `https://line.me/R/ti/p/@your-official-account-id` の形式
   - または、LINE公式アカウントマネージャー > 設定 > 基本情報 > URL

### ステップ2: 環境変数を設定

`.env.local`ファイルに以下を追加：

```env
# LINE公式アカウントのURL（紐づけ用QRコード生成に使用）
NEXT_PUBLIC_LINE_OFFICIAL_ACCOUNT_URL=https://line.me/R/ti/p/@your-official-account-id
```

**Vercelの場合:**
- Vercelダッシュボード → プロジェクト → Settings → Environment Variables
- `NEXT_PUBLIC_LINE_OFFICIAL_ACCOUNT_URL` を追加

---

## 📱 使用方法（管理者向け）

### 1. 生徒詳細ページでQRコードを生成

1. 管理画面 → 生徒一覧 → 対象の生徒をクリック
2. 生徒詳細ページで「LINE紐づけ用QRコード」セクションを確認
3. 「紐づけ用QRコードを生成」ボタンをクリック
4. QRコードが表示されるダイアログが開く

### 2. QRコードをダウンロード

1. ダイアログでQRコードを確認
2. 「ダウンロード」ボタンをクリック
3. QRコード画像を保存

### 3. QRコードを印刷

1. ダウンロードしたQRコード画像を開く
2. 印刷（推奨サイズ: A4または名刺サイズ）
3. NFCカードと一緒に親御さんにお渡し

---

## 📱 使用方法（親御さん向け）

### iPhoneの場合

1. **QRコードを読み取る**
   - カメラアプリを開く
   - QRコードをカメラで読み取る
   - 通知が表示されたらタップ

2. **LINE公式アカウントに遷移**
   - LINEアプリが自動的に開く
   - 友だち追加が必要な場合は、先に友だち追加

3. **「カード紐づけを開始します」とメッセージを送信、またはリッチメニューのボタンをタップ**
   - LINE公式アカウントに「カード紐づけを開始します」とメッセージを送信、またはリッチメニューの「カード紐づけ」ボタンをタップ
   - 返信されたURLをタップ

4. **カードを読み取る**
   - 返信されたURLのページで、お子様のNFCカードを読み取る
   - または、カードIDを手動で入力

### Androidの場合

1. **QRコードを読み取る**
   - GoogleレンズまたはQRコードリーダーアプリを使用
   - QRコードを読み取る

2. **LINE公式アカウントに遷移**
   - LINEアプリが自動的に開く
   - 友だち追加が必要な場合は、先に友だち追加

3. **「カード紐づけを開始します」とメッセージを送信、またはリッチメニューのボタンをタップ**
   - LINE公式アカウントに「カード紐づけを開始します」とメッセージを送信、またはリッチメニューの「カード紐づけ」ボタンをタップ
   - 返信されたURLをタップ

4. **カードを読み取る**
   - 返信されたURLのページで、お子様のNFCカードを読み取る
   - または、カードIDを手動で入力

---

## 🖨️ 印刷時の推奨事項

### サイズ

- **A4サイズ**: 大きなQRコードで読み取りやすい
- **名刺サイズ**: コンパクトで持ち運びやすい
- **推奨サイズ**: 5cm × 5cm 以上

### 印刷品質

- **解像度**: 300dpi以上推奨
- **コントラスト**: 黒と白のコントラストを確保
- **余白**: QRコードの周りに十分な余白を確保

### 印刷物の内容

QRコードと一緒に、以下の情報を印刷すると親切です：

```
【入退室通知システム - 紐づけ用QRコード】

お子様: [生徒名]
QRコードを読み取って、LINE公式アカウントに「カード紐づけを開始します」とメッセージを送信するか、リッチメニューの「カード紐づけ」ボタンをタップしてください。

手順：
1. スマートフォンのカメラでQRコードを読み取る
2. LINE公式アカウントに「カード紐づけを開始します」とメッセージを送信、またはリッチメニューの「カード紐づけ」ボタンをタップ
3. 返信されたURLをタップして、NFCカードを読み取る
```

---

## ⚠️ 注意事項

### QRコードの有効期限

- QRコード自体に有効期限はありません
- ただし、LINE公式アカウントに「紐づけ」と送信した際に発行されるURLは1時間有効です

### LINE公式アカウントの友だち追加

- QRコードを読み取った時点で友だち追加されていない場合、先に友だち追加が必要です
- 友だち追加後、「カード紐づけを開始します」とメッセージを送信するか、リッチメニューの「カード紐づけ」ボタンをタップしてください

### 複数の生徒がいる場合

- 1つのQRコードで複数の生徒を紐づけることはできません
- 各生徒ごとにQRコードを生成してください

---

## 🐛 トラブルシューティング

### 問題1: QRコードが生成されない

**原因:**
- `NEXT_PUBLIC_LINE_OFFICIAL_ACCOUNT_URL`が設定されていない

**解決方法:**
1. `.env.local`ファイルに`NEXT_PUBLIC_LINE_OFFICIAL_ACCOUNT_URL`を設定
2. Vercelの場合、環境変数に設定
3. サーバーを再起動

### 問題2: QRコードを読み取ってもLINE公式アカウントに遷移しない

**原因:**
- LINE公式アカウントのURLが正しくない
- LINEアプリがインストールされていない

**解決方法:**
1. LINE公式アカウントのURLを確認
2. LINEアプリがインストールされているか確認
3. QRコードを再生成

### 問題3: 「カード紐づけを開始します」と送信しても返信が来ない

**原因:**
- Webhookが正しく設定されていない
- 環境変数が設定されていない

**解決方法:**
- `docs/line-webhook-setup-guide.md`を参照

---

## 📚 関連ドキュメント

- `docs/line-parent-self-link-guide.md` - 親御さん向けガイド
- `docs/line-webhook-setup-guide.md` - Webhook設定ガイド
- `docs/line-self-link-guide.md` - 自己紐づけ機能ガイド

---

## 更新履歴

- 2026-01-26: 初版作成

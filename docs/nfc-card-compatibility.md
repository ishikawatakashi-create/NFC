# NFCカード互換性ガイド

## 📋 概要

Web NFC APIの制限により、すべてのNFCカードが読み取れるわけではありません。このドキュメントでは、対応カードと回避策を説明します。

---

## ✅ 対応カード（自動読み取り可能）

以下のカードは、Web NFC APIで**自動的に読み取り可能**です：

### NDEF形式のNFCカード
- **NTAG213 / NTAG215 / NTAG216** - 推奨
- **Mifare Ultralight**
- **Unit Link** など、NDEF対応カード

これらのカードは「NFCで読み取り」ボタンで自動登録できます。

---

## ❌ 非対応カード（自動読み取り不可）

以下のカードは、Web NFC APIで**読み取れません**：

### FeliCa規格
- ❌ **Suica**
- ❌ **PASMO**
- ❌ **ICOCA**
- ❌ **nanaco**
- ❌ **WAON**
- ❌ **楽天Edy**

**理由:** Web NFC APIはFeliCa規格に対応していません。

### セキュリティ保護カード
- ❌ **マイナンバーカード**
- ❌ **パスポート（NFC対応）**
- ❌ **クレジットカード（NFC対応）**

**理由:** セキュリティ保護されており、シリアル番号の読み取りができません。

---

## 🔧 回避策: 手動入力

非対応カードでも、**カードIDを手動で入力**することで登録できます。

### 手順

#### 1. カードIDを取得

別のNFCリーダーアプリでカードIDを取得します。

**推奨アプリ（Android）:**
- **NFC Tools** - Google Playで無料
- **NFC TagInfo** - NXP公式アプリ

**手順:**
1. アプリをインストール
2. カードをタッチ
3. 「UID」または「Serial Number」をコピー
   - 例: `04:1a:2b:3c:4d:5e:6f`

#### 2. 管理画面で手動登録

1. 管理画面 (`/admin/students`) にアクセス
2. 生徒の「カード登録」ボタンをクリック
3. **「手動で入力」ボタン**をクリック
4. 取得したカードIDを入力
5. 「登録」ボタンをクリック

---

## 🎯 推奨カード

本番環境では、以下のカードを推奨します：

### 1. NTAG213 / NTAG215 / NTAG216

**メリット:**
- ✅ Web NFC APIで自動読み取り可能
- ✅ 安価（10枚で1,000円程度）
- ✅ 書き込み可能（トークン方式に切り替え可能）
- ✅ 豊富な種類（カード型、キーホルダー型、シール型等）

**購入先:**
- Amazon: 「NTAG213 カード」で検索
- 楽天: 「NFCカード NTAG」で検索

**例:**
```
NTAG213 NFCカード 10枚セット
- 容量: 144バイト
- 価格: 約1,000円
- 形状: カード型（クレジットカードサイズ）
```

### 2. Unit Link カード

**メリット:**
- ✅ Web NFC APIで自動読み取り可能
- ✅ 既存のUnit Linkシステムと連携可能

---

## 🧪 テスト方法

### 1. カードの対応確認

テストページでカードが読み取れるか確認できます：

```
https://your-domain.com/nfc-test
```

**手順:**
1. 「NFCテスト開始」をクリック
2. カードをタッチ
3. 結果を確認：
   - **🎉 'reading' event fired!** → NDEF対応カード（自動読み取り可能）
   - **⚠️ 'readingerror' event fired** → NDEF非対応カード（手動入力が必要）
   - **❌ No serial number** → 読み取り不可（別のカードを使用）

### 2. 動作確認

#### NDEF対応カード（Unit Link等）
1. 管理画面で「カード登録」→「NFCで読み取り」
2. カードをタッチ
3. 自動的に登録される

#### NDEF非対応カード（Suica等）
1. NFC Toolsアプリでカード IDを取得
2. 管理画面で「カード登録」→「手動で入力」
3. カードIDを入力して登録

---

## ⚠️ 注意事項

### セキュリティ

**シリアル番号（UID）ベース認証のリスク:**
- ⚠️ カードのUIDは複製可能な場合がある
- ⚠️ 専用のNFCリーダーで読み取り可能
- ⚠️ セキュリティレベルは低い

**推奨事項:**
- 🔒 本番環境では専用NFCカード（NTAG213等）を使用
- 🔒 トークン方式（カードに暗号化トークンを書き込む）の使用を検討
- 🔒 重要な認証には使用しない

### プライバシー

- ⚠️ Suica、マイナンバーカード等のカードIDは個人情報です
- ⚠️ カードIDの管理には十分注意してください
- ⚠️ 不要になったカードIDは削除してください

---

## 🔄 トークン方式への切り替え

より高いセキュリティが必要な場合は、トークン方式に切り替えることができます。

### トークン方式とは

1. サーバーで暗号化トークンを生成
2. NFCカードにトークンを書き込み
3. カード読み取り時にトークンを検証

### メリット

- ✅ カードの複製が困難
- ✅ トークンの無効化が可能
- ✅ セキュリティレベルが高い

### 必要なもの

- NTAG213 / NTAG215 / NTAG216 カード（書き込み可能）

### 実装方法

トークン方式の実装は、別途ご相談ください。

---

## 📝 まとめ

| カード種類 | 自動読み取り | 手動入力 | 推奨度 |
|----------|------------|---------|--------|
| NTAG213/215/216 | ✅ | ✅ | ⭐⭐⭐ |
| Unit Link | ✅ | ✅ | ⭐⭐⭐ |
| Suica / PASMO | ❌ | ✅ | ⭐ |
| マイナンバーカード | ❌ | ❌ | ❌ |
| パスポート | ❌ | ❌ | ❌ |

**推奨:**
- **テスト目的:** Suica等を手動入力で使用
- **本番環境:** NTAG213等の専用カードを使用

---

## 🆘 トラブルシューティング

### Q: Unit Linkカードで「JSON parse error」が出る

**A:** PATCH APIメソッドの問題でした。修正済みです。ページを再読み込みしてください。

### Q: Suicaが読み取れない

**A:** Suicaは Web NFC APIで読み取れません。「手動で入力」を使用してください。

### Q: マイナンバーカードが読み取れない

**A:** マイナンバーカードはセキュリティ保護されており、読み取りできません。別のカードを使用してください。

### Q: どのカードを購入すればいい？

**A:** Amazon で「NTAG213 カード」を検索し、10枚セット（約1,000円）を購入することを推奨します。

---

## 📚 関連ドキュメント

- [Android端末での動作確認ガイド](./android-testing-guide.md)
- [シリアル番号ベース認証への変更](./serial-number-authentication.md)
- [NFCカード登録ガイド](./nfc-card-registration-guide.md)


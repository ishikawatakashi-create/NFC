# シリアル番号ベース認証への変更

## 📋 概要

NFCカード認証を**トークンベース**から**シリアル番号（UID）ベース**に変更しました。

これにより、以下のカードでテストが可能になります：
- ✅ マイナンバーカード
- ✅ Suica / PASMO などの交通系ICカード
- ✅ パスポート（NFC対応）
- ✅ その他のNFC-A/B規格カード

---

## 🔄 変更内容

### 1. キオスク画面（入室・退室）

**変更前:**
- NDEFメッセージから `iru:card:` で始まるトークンを読み取り
- トークンがない場合はエラー

**変更後:**
- カードのシリアル番号（UID）を直接読み取り
- シリアル番号で生徒を検索

**ファイル:**
- `app/kiosk/entry/page.tsx`
- `app/kiosk/exit/page.tsx`

### 2. カード検証API

**変更前:**
- トークンのみで検証
- `card_tokens` テーブルと `student_cards` テーブルを使用

**変更後:**
- シリアル番号での検証を優先
- `students` テーブルの `card_id` カラムを直接参照
- トークンベース認証も後方互換性のため残存

**ファイル:**
- `app/api/cards/verify/route.ts`

**APIリクエスト:**
```json
// 新方式（シリアル番号）
{
  "serialNumber": "04:1a:2b:3c:4d:5e:6f"
}

// 旧方式（トークン）- 後方互換性のため残存
{
  "token": "iru:card:xxxxx"
}
```

### 3. 管理画面（カード登録）

**変更前:**
1. サーバーからトークンを発行
2. NFCカードにトークンを書き込み
3. トークンをDBに保存

**変更後:**
1. NFCカードのシリアル番号を読み取り
2. シリアル番号を `students.card_id` に直接保存
3. カードへの書き込みは不要

**ファイル:**
- `app/admin/students/page.tsx`

---

## 🚀 使用方法

### 1. カード登録（管理画面）

1. 管理画面 (`/admin/students`) にアクセス
2. 生徒の「カード登録」ボタンをクリック
3. 「開始」ボタンを押す
4. 登録したいカード（マイナンバーカード、Suica等）をタッチ
5. シリアル番号が自動的に登録される

### 2. 入退室記録（キオスク画面）

1. キオスク画面 (`/kiosk/entry` または `/kiosk/exit`) にアクセス
2. 「カードをタッチ」ボタンを押す
3. 登録済みのカードをタッチ
4. 入退室が記録される

---

## ⚠️ 注意事項

### セキュリティ

**シリアル番号ベース認証のリスク:**
- ⚠️ カードのシリアル番号（UID）は複製可能な場合がある
- ⚠️ 専用のNFCリーダーで読み取り可能
- ⚠️ セキュリティレベルは低い

**推奨事項:**
- 🔒 本番環境では専用NFCカード（NTAG213等）にトークンを書き込む方式を使用
- 🔒 シリアル番号方式はテスト目的のみに使用
- 🔒 重要な認証には使用しない

### 後方互換性

- ✅ トークンベース認証も引き続き動作します
- ✅ 既存の登録済みトークンは有効です
- ✅ 新旧両方式が共存可能です

---

## 🔧 技術詳細

### データベース

シリアル番号は `students` テーブルの `card_id` カラムに保存されます：

```sql
-- students テーブル
CREATE TABLE students (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  card_id VARCHAR(255), -- ← シリアル番号を保存
  ...
);
```

### Web NFC API

```javascript
// シリアル番号の読み取り
const ndef = new NDEFReader();
await ndef.scan();

ndef.addEventListener("reading", (event) => {
  const serialNumber = event.serialNumber; // ← シリアル番号
  console.log("Card Serial:", serialNumber);
  // 例: "04:1a:2b:3c:4d:5e:6f"
});
```

### シリアル番号のフォーマット

Web NFC APIから取得されるシリアル番号は、16進数のコロン区切り形式です：

```
例: 04:1a:2b:3c:4d:5e:6f
```

---

## 🧪 テスト手順

### 1. 環境確認

- ✅ ngrokでHTTPS環境が起動している
- ✅ Android端末でChromeブラウザを使用
- ✅ NFCが有効になっている

### 2. カード登録テスト

1. `https://your-ngrok-url.ngrok-free.app/admin/students` にアクセス
2. テスト用の生徒を作成（まだ作成していない場合）
3. 「カード登録」をクリック
4. マイナンバーカードまたはSuicaをタッチ
5. 「✓ 登録完了」が表示されることを確認
6. カードIDが表示されることを確認

### 3. 入室テスト

1. `https://your-ngrok-url.ngrok-free.app/kiosk/entry` にアクセス
2. 「カードをタッチ」をクリック
3. 登録したカードをタッチ
4. 「○○さんの入室を記録しました。」が表示されることを確認

### 4. 退室テスト

1. `https://your-ngrok-url.ngrok-free.app/kiosk/exit` にアクセス
2. 「カードをタッチ」をクリック
3. 登録したカードをタッチ
4. 「○○さんの退室を記録しました。」が表示されることを確認

### 5. エラーケーステスト

**未登録カードのテスト:**
1. キオスク画面で未登録のカードをタッチ
2. 「このカードは登録されていません」エラーが表示されることを確認

---

## 🔄 元の方式に戻す方法

シリアル番号方式からトークン方式に戻したい場合は、以下のコミットをrevertしてください：

```bash
git log --oneline --grep="シリアル番号"
# コミットハッシュを確認

git revert <commit-hash>
```

または、以下のファイルを元に戻してください：
- `app/kiosk/entry/page.tsx`
- `app/kiosk/exit/page.tsx`
- `app/api/cards/verify/route.ts`
- `app/admin/students/page.tsx`

---

## 📝 関連ドキュメント

- [Android端末での動作確認ガイド](./android-testing-guide.md)
- [NFCカード登録ガイド](./nfc-card-registration-guide.md)
- [キオスク画面ガイド](./kiosk-screen-guide.md)

---

## ❓ トラブルシューティング

### エラー: "カードのシリアル番号を読み取れませんでした"

**原因:**
- カードがNFC-A/B規格に対応していない
- カードの読み取り位置が悪い
- NFCが無効になっている

**対処法:**
1. カードを端末の背面中央にゆっくりタッチ
2. Android設定でNFCが有効か確認
3. 別のNFCカードで試す

### エラー: "このカードは登録されていません"

**原因:**
- カードが管理画面で登録されていない
- 別のカードを使用している

**対処法:**
1. 管理画面で該当の生徒にカードを登録
2. 正しいカードを使用しているか確認

### カード登録時にタイムアウトする

**原因:**
- カードをタッチするのが遅い
- カードの読み取りに失敗している

**対処法:**
1. 「開始」ボタンを押した直後にカードをタッチ
2. カードを端末にしっかりと密着させる
3. 15秒以内にタッチする

---

## 📅 変更履歴

- **2025-12-28**: シリアル番号ベース認証を実装（テスト目的）


# NFCシリアル番号読み取り問題のデバッグ手順

## 🔍 問題の状況

「カードのシリアル番号を読み取れませんでした」というエラーが発生している場合の対処方法です。

---

## 📋 ステップ1: 簡単な確認方法（まずこれを試す）

### 1-1. 画面に表示されるエラーメッセージを確認

Android端末でNFCカードをタッチした際に、画面に表示されるエラーメッセージに以下の情報が含まれています：

- イベントプロパティ一覧
- `serialNumber`の値
- `message`の値

この情報を確認してください。

### 1-2. `/nfc-test`ページでテスト

1. Android端末で `/nfc-test` ページにアクセス
2. 「NFCテスト開始」ボタンをタップ
3. NFCカードをタッチ
4. 画面に表示されるログを確認
   - `⚠️ 'readingerror' event fired` が表示されるか
   - `📋 Serial Number:` の後にシリアル番号が表示されるか

### 1-3. 管理画面でカード登録ができているか確認

1. 管理画面 (`/admin/students`) にアクセス
2. 該当の生徒の「カード登録」ボタンをクリック
3. 「開始」ボタンをタップ
4. NFCカードをタッチ
5. シリアル番号が取得できるか確認

**管理画面で取得できるのに、入口画面で取得できない場合**は、コードの問題です。

---

## 📋 ステップ2: リモートデバッグで詳細を確認（推奨）

### 2-1. Wi-Fi経由でリモートデバッグを設定

1. **Android端末の設定**
   - 設定 → システム → 開発者オプション → 「ワイヤレスデバッグ」をON
   - 「ワイヤレスデバッグ」をタップ → 「ペア設定コードを使用してデバイスをペア設定」をタップ
   - 6桁のペア設定コードとIPアドレス:ポート番号が表示される
     - 例: `192.168.1.100:12345`

2. **PCのChromeで接続**
   - PCのChromeで `chrome://inspect/#devices` を開く
   - 「Discover network targets」セクションの「Configure...」をクリック
   - 「Add」ボタンをクリック
   - Android端末に表示されたIPアドレス:ポート番号を入力
   - 「Add」をクリック
   - 「Remote Target」セクションにAndroid端末が表示される
   - 「inspect」リンクをクリック

### 2-2. コンソールでログを確認

1. デバッグツールの「Console」タブを開く
2. Android端末で入口画面 (`/kiosk/entry`) を開く
3. 「カードをタッチ」ボタンをタップ
4. NFCカードをタッチ
5. コンソールに表示される以下のログを確認：
   - `Reading error (NDEF not supported):`
   - `Event keys:`
   - `Event serialNumber:`
   - `Full event object:`

### 2-3. 確認してほしい情報

以下の情報を共有してください：

1. **コンソールに表示されるログ**
   - `Event keys:` の後に表示されるプロパティ一覧
   - `Event serialNumber:` の値（`undefined` か、実際の値か）
   - `Full event object:` で表示されるイベントオブジェクト全体

2. **画面に表示されるエラーメッセージ**
   - イベントプロパティ一覧
   - `serialNumber`の値

---

## 📋 ステップ3: 問題の原因を特定

### 原因1: `readingerror`イベントに`serialNumber`が含まれていない

**症状**: コンソールで `Event serialNumber: undefined` と表示される

**原因**: 
- Androidの実装によっては、`readingerror`イベントに`serialNumber`プロパティが含まれない場合があります
- 特にSuicaなどのFeliCaカードの場合、シリアル番号が取得できない可能性があります

**対処法**: 
- イベントオブジェクトの他のプロパティからシリアル番号を取得する方法を試す
- または、別の方法でシリアル番号を取得する

### 原因2: シリアル番号のフォーマットが異なる

**症状**: シリアル番号は取得できるが、データベースと一致しない

**原因**: 
- 大文字/小文字の違い
- コロンの有無
- 空白の有無

**対処法**: 
- 正規化処理を追加済み（小文字に統一、前後の空白を削除）
- データベースに保存されているシリアル番号のフォーマットを確認

### 原因3: カードが登録されていない

**症状**: シリアル番号は取得できるが、「このカードは登録されていません」と表示される

**原因**: 
- データベースにシリアル番号が登録されていない
- シリアル番号のフォーマットが一致していない

**対処法**: 
- 管理画面でカードを再登録
- データベースの`students.card_id`カラムを確認

---

## 📋 ステップ4: 解決方法

### 方法1: イベントオブジェクトの詳細を確認

コンソールで表示されるイベントオブジェクトのすべてのプロパティを確認し、シリアル番号が別のプロパティ名で提供されている可能性があります。

### 方法2: 代替の取得方法を試す

`readingerror`イベントでシリアル番号が取得できない場合、以下の方法を試します：

1. `event.message`から取得
2. イベントオブジェクトの他のプロパティから取得
3. 別のイベント（`reading`イベント）から取得

### 方法3: 手動登録で対応

一時的な解決策として、NFCツールで取得したシリアル番号を手動で登録することも可能です。

---

## 🆘 緊急時の対処法

リモートデバッグができない場合でも、以下の情報があれば問題を特定できます：

1. **画面に表示されるエラーメッセージ**
   - イベントプロパティ一覧
   - `serialNumber`の値

2. **管理画面での動作**
   - 管理画面でカード登録ができるか
   - シリアル番号が取得できるか

3. **`/nfc-test`ページでの動作**
   - シリアル番号が取得できるか

これらの情報を共有していただければ、問題を特定して修正できます。


# パスワードリセットメールの日本語化設定ガイド

## 概要

Supabase Authから送信されるパスワードリセットメールを日本語にカスタマイズする方法です。

---

## 🔧 設定手順

### 1. Supabaseダッシュボードにアクセス

1. [Supabaseダッシュボード](https://app.supabase.com)にログイン
2. プロジェクトを選択

### 2. メールテンプレートの設定

1. 左側のメニューから **Authentication** をクリック
2. **Email Templates** タブを選択
3. **Reset Password** テンプレートを選択

### 3. 日本語テンプレートの設定

以下の日本語テンプレートをコピーして、Supabaseダッシュボードのテンプレートエディタに貼り付けてください：

**⚠️ 重要**: スパム警告を回避するため、以下の要件を満たしています：
- シンプルで明確な件名
- トランザクション目的のみの内容
- 最小限のリンク
- マーケティング的な表現を避ける

#### 件名（Subject）
```
パスワードリセット
```

#### 本文（Body - HTML）
```html
<html>
<body>
<p>パスワードリセットのリクエストを受け付けました。</p>

<p>以下のリンクをクリックして、新しいパスワードを設定してください：</p>

<p><a href="{{ .ConfirmationURL }}">パスワードを設定</a></p>

<p>このリンクは24時間有効です。</p>

<p>このリクエストをしていない場合は、このメールを無視してください。</p>
</body>
</html>
```

#### 本文（Body - Plain Text）
```
パスワードリセットのリクエストを受け付けました。

以下のリンクをクリックして、新しいパスワードを設定してください：

{{ .ConfirmationURL }}

このリンクは24時間有効です。

このリクエストをしていない場合は、このメールを無視してください。
```

---

## ⚠️ スパム警告を回避するための注意事項

Supabaseのメールテンプレートを保存する際に「Please rectify all spam warnings before saving」という警告が表示される場合、以下の点を確認してください：

### 1. 件名の要件
- ✅ 短く、明確で、アクション指向（例：「パスワードリセット」）
- ❌ スパムキーワードを避ける（「無料」「緊急」「報酬」など）
- ❌ 過度な記号や大文字の連続を避ける

### 2. 本文の要件
- ✅ シンプルで、トランザクション目的のみに集中
- ✅ 最小限のリンク（通常は1つ）
- ✅ 明確で簡潔な説明
- ❌ マーケティング的な内容や宣伝文句を避ける
- ❌ 複数のCTA（行動喚起）を避ける

### 3. HTML構造
- ✅ 適切なHTML構造（`<html>`, `<body>`タグを含む）
- ✅ インラインCSSを使用（外部スタイルシートを避ける）
- ❌ 複雑なテーブル構造や不要な画像を避ける

### 4. リンクの配置
- ✅ 主要なアクションリンクは1つだけ
- ✅ 絶対URLを使用（`{{ .ConfirmationURL }}`は自動的に絶対URL）
- ❌ 複数の外部リンクを避ける

### 5. 送信者情報
- ✅ カスタムドメインを使用（可能な場合）
- ✅ 一貫した送信者名とアドレス
- ✅ SPF、DKIM、DMARCレコードを設定

### トラブルシューティング

スパム警告が表示される場合：

1. **件名を確認**: 短く、明確で、スパムキーワードがないか確認
2. **本文を簡素化**: 不要な説明やリンクを削除
3. **HTML構造を確認**: 適切なタグが使用されているか確認
4. **テンプレート変数の確認**: `{{ .ConfirmationURL }}`などの変数が正しく使用されているか確認

上記のテンプレートは、これらの要件を満たすように設計されています。

---

## 📝 テンプレート変数

Supabaseのメールテンプレートでは、以下の変数が使用できます：

- `{{ .ConfirmationURL }}`: パスワードリセット用のURL（自動生成）
- `{{ .Email }}`: ユーザーのメールアドレス
- `{{ .Token }}`: リセットトークン（通常は使用しない）

---

## ✅ 設定後の確認

1. テンプレートを保存（スパム警告が表示されないことを確認）
2. ログイン画面で「パスワードを忘れた場合」をクリック
3. メールアドレスを入力して送信
4. 受信したメールが日本語になっているか確認
5. メールがスパムフォルダに入っていないか確認

---

## 🔗 リダイレクトURLの設定

パスワードリセットメールのリンクが正しく動作するように、SupabaseでリダイレクトURLを設定する必要があります。

### Supabaseダッシュボードでの設定

1. **Authentication** → **URL Configuration** を開く
2. **Redirect URLs** セクションで、以下のURLを追加：
   ```
   https://nfctoukalab.vercel.app/admin/reset-password
   ```
3. ローカル開発環境を使用する場合：
   ```
   http://localhost:3001/admin/reset-password
   ```
4. 「Save」をクリック

### 環境変数の設定（推奨）

Vercelの環境変数に `NEXT_PUBLIC_APP_URL` を設定することで、本番環境のURLを明示的に指定できます：

1. Vercelダッシュボード → プロジェクト → **Settings** → **Environment Variables**
2. 以下の環境変数を追加：
   - **Name**: `NEXT_PUBLIC_APP_URL`
   - **Value**: `https://nfctoukalab.vercel.app`
   - **Environment**: Production（本番環境のみ）
3. 環境変数を追加した後、**再デプロイ**が必要です

**注意**: 環境変数を設定しない場合、コードは自動的に現在のドメイン（`window.location.origin`）を使用します。Vercelでは正しく動作しますが、明示的に設定することを推奨します。

---

## 🔄 他のメールテンプレートも日本語化する場合

以下のテンプレートも必要に応じて日本語化できます：

- **Magic Link**: マジックリンクログイン用
- **Change Email Address**: メールアドレス変更用
- **Email Confirmation**: メール確認用
- **Invite User**: ユーザー招待用

各テンプレートについても、同様の手順で日本語化できます。

---

## 📚 参考リンク

- [Supabase Email Templates Documentation](https://supabase.com/docs/guides/auth/auth-email-templates)
- [Supabase Auth Settings](https://supabase.com/docs/guides/auth/auth-settings)

---

**最終更新**: 2024年12月

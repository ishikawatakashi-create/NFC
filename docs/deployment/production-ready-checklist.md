# 本番環境運用準備チェックリスト（開発側面）

**最終更新**: 2025年1月  
**対象**: NFCカード入退室管理システム  
**目的**: 本番環境で実際に生徒達相手に使えるようになるための開発・技術的な準備

---

## 📋 目次

1. [概要](#概要)
2. [Phase 1: セキュリティ実装・確認（必須）](#phase-1-セキュリティ実装確認必須)
3. [Phase 2: 本番環境設定（必須）](#phase-2-本番環境設定必須)
4. [Phase 3: テスト・検証（必須）](#phase-3-テスト検証必須)
5. [Phase 4: エラーハンドリング・監視（推奨）](#phase-4-エラーハンドリング監視推奨)
6. [Phase 5: パフォーマンス・最適化（推奨）](#phase-5-パフォーマンス最適化推奨)
7. [本番運用開始前の最終確認](#本番運用開始前の最終確認)

---

## 概要

このドキュメントは、開発環境とデプロイ環境で動作しているNFCカード入退室管理システムを、**本番環境で実際に生徒達相手に使えるようになるための開発・技術的な準備**に焦点を当てたチェックリストです。

### 現在の状態

- ✅ Vercelにデプロイ済み（`nfc-toukalab.vercel.app`）
- ✅ 管理者認証機能実装済み
- ✅ LINE通知機能実装済み
- ✅ RLS（Row Level Security）設定済み
- ✅ 基本的な機能は動作中

### 本番運用開始までの流れ

```
Phase 1: セキュリティ実装・確認（2-3日）
  ↓
Phase 2: 本番環境設定（1-2日）
  ↓
Phase 3: テスト・検証（2-3日）
  ↓
Phase 4: エラーハンドリング・監視（1-2日）
  ↓
Phase 5: パフォーマンス・最適化（1-2日）
  ↓
本番運用開始
```

---

## Phase 1: セキュリティ実装・確認（必須）

### 🔒 1.1 認証・認可の確認

#### ✅ 管理者認証の動作確認
- [ ] 管理者ログインが正しく動作するか確認
- [ ] ログアウトが正しく動作するか確認
- [ ] セッションの有効期限が適切か確認
- [ ] 未認証ユーザーが管理画面にアクセスできないか確認

#### ✅ APIエンドポイントの認証チェック
- [ ] `/api/students` に認証チェックが実装されているか確認
- [ ] `/api/cards/*` に認証チェックが実装されているか確認
- [ ] `/api/access-logs` に認証チェックが実装されているか確認
- [ ] `/api/admin/*` に認証チェックが実装されているか確認
- [ ] キオスク画面用API（`/api/cards/verify`）は認証不要で正しいか確認

**確認方法**: 
- 未認証でAPIエンドポイントにアクセスして401エラーが返るか確認
- 認証済みでアクセスして正常に動作するか確認

**参考**: 
- `middleware.ts` - 管理画面の認証チェック
- `app/api/admin/check/route.ts` - 管理者チェックAPI

---

### 🔐 1.2 データ保護

#### ✅ 環境変数の確認
- [ ] `.env.local` がGitにコミットされていないか確認
  ```bash
  git ls-files | grep -E "\.env"
  ```
- [ ] `.gitignore` に `.env*` が含まれているか確認
- [ ] 本番環境（Vercel）の環境変数が正しく設定されているか確認
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY`
  - `SITE_ID`
  - `LINE_CHANNEL_ACCESS_TOKEN`

#### ✅ データベースセキュリティ
- [ ] RLS（Row Level Security）がすべてのテーブルで有効化されているか確認
- [ ] サービスロールキーがクライアント側に露出していないか確認
- [ ] データベース接続が暗号化されているか確認（Supabaseは自動対応）

**確認方法**: 
- SupabaseダッシュボードでRLSの状態を確認
- `migrations/enable_rls_on_all_tables.sql` が適用されているか確認

**参考ドキュメント**: 
- `docs/rls-setup-guide.md`

---

### 🛡️ 1.3 セキュリティヘッダー・設定

#### ✅ HTTPSの確認
- [ ] VercelでHTTPSが強制されているか確認（自動対応）
- [ ] HTTPアクセスがHTTPSにリダイレクトされるか確認

#### ✅ CORS設定の確認
- [ ] 本番環境でのCORS設定が適切か確認
- [ ] キオスク画面からのAPIアクセスが正常に動作するか確認

#### ✅ セキュリティヘッダーの設定（任意）
- [ ] `next.config.mjs` でセキュリティヘッダーを設定
  - `X-Frame-Options: DENY`
  - `X-Content-Type-Options: nosniff`
  - `Referrer-Policy: strict-origin-when-cross-origin`

---

### 🚦 1.4 レート制限（任意・推奨）

#### ✅ ログイン試行回数制限
- [ ] ログイン試行回数制限の実装を検討
- [ ] ブルートフォース攻撃対策の実装を検討

**実装方法**: 
- Vercel Edge Configまたは外部サービス（Upstash Redis等）を使用
- 自社内利用のため、厳密な実装は任意

---

## Phase 2: 本番環境設定（必須）

### 📌 重要：Vercelを本番環境として使用

**Vercelのデプロイ環境をそのまま本番環境として使用します。**

- ✅ Vercelの無料プランでも本番環境として使用可能
- ✅ `nfc-toukalab.vercel.app` のドメインでそのまま使用可能
- ✅ カスタムドメインの設定は任意（独自ドメインが必要な場合のみ）
- ✅ HTTPSは自動で有効化される
- ✅ 環境変数を「Production」環境として設定する必要がある

**注意点**:
- Vercelの無料プランには制限があります（帯域幅、関数実行時間など）
- 自社内利用であれば、無料プランで十分な場合が多い
- 必要に応じてVercel Proプランへのアップグレードを検討

---

### 🚀 2.1 デプロイ設定の確認

#### ✅ Vercel設定
- [ ] **本番環境（Production）としてデプロイされているか確認**
  - Vercelダッシュボードで「Production」環境としてデプロイされているか確認
  - `vercel --prod` でデプロイするか、GitHub連携でmainブランチにプッシュすると自動でProduction環境にデプロイされる
- [ ] 環境変数が正しく設定されているか確認
  - **重要**: 環境変数を「Production」環境として設定する
  - Vercelダッシュボード → Settings → Environment Variables で確認
- [ ] ビルドコマンドが正しく設定されているか確認
- [ ] Node.jsバージョンが適切か確認（`package.json`の`engines`を確認）

#### ✅ カスタムドメイン（任意）
- [ ] カスタムドメインの設定（必要な場合）
  - 独自ドメインが必要な場合のみ設定
  - `vercel.app` のドメインで問題なければ設定不要
- [ ] DNS設定の確認（カスタムドメインを使用する場合）
- [ ] SSL証明書の確認（Vercelは自動対応）

---

### 🔧 2.2 環境変数の最終確認

#### ✅ 必須環境変数（Production環境として設定）
- [ ] `NEXT_PUBLIC_SUPABASE_URL` - SupabaseプロジェクトURL
- [ ] `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase匿名キー
- [ ] `SUPABASE_SERVICE_ROLE_KEY` - Supabaseサービスロールキー（サーバー側のみ）
- [ ] `SITE_ID` - サイトID（UUID）

#### ✅ オプション環境変数
- [ ] `LINE_CHANNEL_ACCESS_TOKEN` - LINE通知機能を使用する場合

**重要**: 環境変数は「Production」環境として設定する必要があります。

**確認方法**: 
1. Vercelダッシュボード → プロジェクト → Settings → Environment Variables
2. 各環境変数が「Production」にチェックが入っているか確認
3. 本番環境のURL（`https://nfc-toukalab.vercel.app/envcheck`）にアクセスして環境変数が正しく読み込まれているか確認

---

### 📊 2.3 データベース設定

#### ✅ Supabase設定
- [ ] Supabaseプロジェクトが本番環境用に設定されているか確認
- [ ] データベースのバックアップ設定を確認
- [ ] 接続プールの設定を確認（大量アクセス時）

---

## Phase 3: テスト・検証（必須）

### 🧪 3.1 機能テスト

#### ✅ 認証機能
- [ ] 管理者ログイン
- [ ] 管理者ログアウト
- [ ] 未認証ユーザーのアクセス拒否

#### ✅ 生徒管理機能
- [ ] 生徒の追加
- [ ] 生徒の編集
- [ ] 生徒の削除
- [ ] 生徒一覧の表示
- [ ] 生徒詳細の表示
- [ ] CSV一括登録

#### ✅ NFCカード管理機能
- [ ] カードトークンの発行
- [ ] カードへのトークン書き込み（Web NFC）
- [ ] カードの検証（入室・退室）
- [ ] カードの無効化
- [ ] カード登録の削除

#### ✅ 入退室管理機能
- [ ] 入室記録の作成
- [ ] 退室記録の作成
- [ ] 入退室ログの表示
- [ ] 入退室ログのフィルタリング
- [ ] 入退室ログのCSV出力
- [ ] 入退室ログの訂正

#### ✅ LINE通知機能
- [ ] 入室時のLINE通知送信
- [ ] 退室時のLINE通知送信
- [ ] 通知テンプレートの適用
- [ ] 通知履歴の確認

#### ✅ 設定機能
- [ ] 通知テンプレートの保存（実装されている場合）
- [ ] ポイント設定の保存（実装されている場合）

---

### 🔍 3.2 セキュリティテスト

#### ✅ 認証バイパスの試行
- [ ] 未認証で管理画面にアクセスできないか確認
- [ ] 未認証でAPIエンドポイントにアクセスできないか確認
- [ ] セッションを偽造してアクセスできないか確認

#### ✅ 入力値検証
- [ ] SQLインジェクション対策の確認
- [ ] XSS対策の確認
- [ ] CSRF対策の確認

**確認方法**: 
- 管理画面の入力フォームに悪意のあるスクリプトを入力
- APIエンドポイントに不正なパラメータを送信

---

### 📈 3.3 負荷テスト（簡易版）

#### ✅ 同時アクセス数の確認
- [ ] 想定同時アクセス数での動作確認
- [ ] 複数のキオスク端末からの同時アクセス確認

#### ✅ 大量データ時のパフォーマンス確認
- [ ] 生徒数が100人、500人、1000人時の動作確認
- [ ] 入退室ログが1000件、5000件、10000件時の動作確認
- [ ] ページ読み込み速度の確認

#### ✅ APIレスポンス時間の確認
- [ ] 主要APIエンドポイントのレスポンス時間を測定
- [ ] 実用上問題ない速度か確認（目安: 1秒以内）

---

## Phase 4: エラーハンドリング・監視（推奨）

### ⚠️ 4.1 エラーハンドリングの改善

#### ✅ エラーページのカスタマイズ
- [ ] 404エラーページの作成（`app/not-found.tsx`）
- [ ] 500エラーページの作成（`app/error.tsx`）
- [ ] エラーページがユーザーフレンドリーか確認

#### ✅ エラーメッセージの改善
- [ ] 技術的なエラーメッセージをユーザー向けに変換
- [ ] エラーログはサーバー側に記録し、ユーザーには簡潔なメッセージを表示

#### ✅ ネットワークエラー時の対応
- [ ] ネットワークエラー時のリトライ機能の実装（任意）
- [ ] オフライン時の対応（任意）

---

### 📊 4.2 監視・ログ設定

#### ✅ エラーログの確認方法
- [ ] Vercelダッシュボードでログを確認する方法を文書化
- [ ] エラーログの確認頻度を決定

#### ✅ 監視ツールの導入（任意）
- [ ] Vercel Analyticsの有効化（既に導入済み）
- [ ] エラー監視ツール（Sentry等）の導入を検討
- [ ] パフォーマンス監視の設定

**参考ドキュメント**: 
- `docs/vercel-logs-guide.md`

---

### 🔄 4.3 バックアップ・復元

#### ✅ データベースバックアップ
- [ ] Supabaseの自動バックアップ設定を確認
- [ ] 手動バックアップ手順の文書化
- [ ] 復元手順の文書化

#### ✅ コードバックアップ
- [ ] Gitリポジトリのバックアップ確認
- [ ] リリースタグの作成方法を文書化

---

## Phase 5: パフォーマンス・最適化（推奨）

### ⚡ 5.1 パフォーマンス最適化

#### ✅ ビルド最適化
- [ ] ビルド時間の確認
- [ ] バンドルサイズの確認
- [ ] 不要な依存関係の削除

#### ✅ ページ読み込み速度
- [ ] Lighthouseでパフォーマンススコアを確認
- [ ] 画像最適化の確認
- [ ] コード分割の確認

#### ✅ データ取得の最適化
- [ ] 不要なデータ取得の削減
- [ ] キャッシュ戦略の検討
- [ ] ページネーションの実装（大量データ時）

---

### 📱 5.2 キオスク画面の最適化

#### ✅ パフォーマンス確認
- [ ] キオスク画面の読み込み速度
- [ ] NFC読み取り時の応答速度
- [ ] エラー表示の速度

#### ✅ オフライン対応（任意）
- [ ] オフライン時の動作確認
- [ ] オフライン時のエラーメッセージ

---

## 本番運用開始前の最終確認

### ✅ 最終チェックリスト

#### セキュリティ
- [ ] 認証・認可が正しく動作している
- [ ] 環境変数が正しく設定されている
- [ ] RLSがすべてのテーブルで有効化されている

#### 機能
- [ ] 主要機能がすべて動作している
- [ ] エラーハンドリングが適切に実装されている
- [ ] ユーザーフレンドリーなエラーメッセージが表示される

#### パフォーマンス
- [ ] ページ読み込み速度が実用的
- [ ] APIレスポンス時間が実用的
- [ ] 大量データ時も動作する

#### 監視・バックアップ
- [ ] ログの確認方法が分かる
- [ ] バックアップ設定が完了している
- [ ] 復元手順が文書化されている

---

### 🚀 本番運用開始

#### 段階的な運用開始

1. **テスト運用（1-2週間）**
   - 社内スタッフのみでテスト運用
   - 実際の入退室記録の確認
   - LINE通知の動作確認
   - 問題点の洗い出しと修正

2. **限定運用（1週間）**
   - 一部の生徒のみで運用開始
   - 保護者へのLINE通知開始
   - フィードバック収集

3. **全面運用開始**
   - すべての生徒で運用開始
   - 本番運用の開始

---

## 📝 チェックリストサマリー

### 必須項目（本番運用開始前に完了必須）

- [ ] **Phase 1: セキュリティ実装・確認**
  - [ ] 認証・認可の確認
  - [ ] データ保護の確認
  - [ ] 環境変数の確認
- [ ] **Phase 2: 本番環境設定**
  - [ ] デプロイ設定の確認
  - [ ] 環境変数の最終確認
  - [ ] データベース設定の確認
- [ ] **Phase 3: テスト・検証**
  - [ ] 機能テストの実施
  - [ ] セキュリティテストの実施
  - [ ] 負荷テストの実施（簡易版）

### 推奨項目（運用開始後も継続的に実施）

- [ ] **Phase 4: エラーハンドリング・監視**
  - [ ] エラーハンドリングの改善
  - [ ] 監視・ログ設定
  - [ ] バックアップ設定
- [ ] **Phase 5: パフォーマンス・最適化**
  - [ ] パフォーマンス最適化
  - [ ] キオスク画面の最適化

---

## 🎯 次のステップ

1. **Phase 1の確認**: セキュリティ実装を最優先で確認
2. **Phase 2の実施**: 本番環境設定を完了
3. **Phase 3の実施**: テスト・検証を実施
4. **Phase 4・5の検討**: エラーハンドリング・パフォーマンス最適化を実施
5. **段階的運用開始**: テスト運用 → 限定運用 → 全面運用

---

## 📚 関連ドキュメント

- `docs/vercel-deployment-guide.md` - デプロイ手順
- `docs/admin-authentication-setup.md` - 認証設定
- `docs/rls-setup-guide.md` - セキュリティ設定
- `docs/vercel-logs-guide.md` - ログ確認方法
- `docs/current-status-analysis.md` - 現状分析

---

**最終更新**: 2025年1月  
**バージョン**: 1.0.0

